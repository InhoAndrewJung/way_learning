<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="memberMapper">

	<resultMap type="member" id="memberRM">
		<result property="userId" column="user_id" />
		<result property="email" column="email" />
		<result property="password" column="password" />
		<result property="activity" column="activity" />
		<result property="imgProfile" column="img_profile" />
		<result property="regDate" column="reg_date" />

	</resultMap>


	<sql id="selectMember">
		select user_id,password,email, activity, img_profile,
		reg_date from
		wl_member
	</sql>



	<select id="login" parameterType="member" resultMap="memberRM">
		select
		user_id,email, activity, img_profile, reg_date from wl_member
		where
		user_id=#{id} and password=#{password}
	</select>

	<update id="updateMember" parameterType="member">
		update
		wl_member set
		password=#{password},email=#{email},img_profile=#{imgProfile}
		where
		user_id=#{userId}
	</update>

	<insert id="registerMember" parameterType="member">
		insert into
		wl_member(user_id,password,email,img_profile)
		values(#{userId},#{password},#{email},#{imgProfile})
	</insert>
	<select id="idcheck" resultType="int">
		select count(*) from wl_member
		where user_id=#{value}
	</select>
	<select id="emailcheck" resultType="int">
		SELECT count(*)
		FROM wl_member
		WHERE email=#{value}
	</select>
	<select id="findMemberById" resultMap="memberRM">
		SELECT
		user_id,password,email,activity,img_profile,reg_date
		FROM wl_member
		WHERE user_id=#{value}
	</select>

	<select id="findIdByEmail" parameterType="string" resultType="string">
		SELECT user_id
		FROM wl_member
		WHERE email=#{value}
	</select>

	<update id="updatefindPass">
		UPDATE wl_member
		SET password=#{password}
		WHERE
		user_id=#{userId}
	</update>



	<!-- 마이 페이지 관련 -->
	<resultMap type="answerResult" id="answerResultRM">
		<result property="userId" column="user_id" />
		<result property="questionNo" column="question_no" />
		<result property="myCntSubmit" column="my_cnt_submit" />
		<result property="myCntWrong" column="my_cnt_wrong" />
		<result property="myCntRight" column="my_cnt_right" />
		<result property="myRightPercent" column="my_right_Percent" />
	</resultMap>

	<select id="selectRightNo" resultType="string">
		select QUESTION_NO from wl_answer_result where user_id=#{userId} and
		MY_CNT_RIGHT != 0
	</select>

	<select id="selectWrongNo" resultType="string">
		select QUESTION_NO from wl_answer_result where user_id=#{userId} and
		MY_CNT_RIGHT = 0 and MY_CNT_WRONG is not null
	</select>

	<select id="selectMyRecord" resultMap="answerResultRM">
		select user_id ,sum(MY_CNT_SUBMIT) MY_CNT_SUBMIT,sum(MY_CNT_RIGHT)
		MY_CNT_RIGHT,sum(MY_CNT_WRONG) MY_CNT_WRONG from wl_answer_result
		where user_id=#{userId} group by user_id
	</select>

	<select id="selectMyRanking" resultType="int">
		select a.ranking from(select user_id ,sum(MY_CNT_SUBMIT)
		my_cnt_submit,sum(MY_CNT_RIGHT)my_cnt_right,sum(MY_CNT_WRONG)
		my_cnt_wrong,rank() over(order by sum(MY_CNT_SUBMIT) desc)as ranking
		from wl_answer_result group by user_id)a
		where user_id=#{userId}
	</select>

	<select id="selectAllRanking" parameterType="string" resultMap="answerResultRM">
		select user_id ,sum(MY_CNT_SUBMIT) MY_CNT_SUBMIT, sum(MY_CNT_RIGHT)
		MY_CNT_RIGHT,sum(MY_CNT_WRONG) MY_CNT_WRONG, round((
		sum(MY_CNT_RIGHT)/sum(MY_CNT_SUBMIT)*100),2) my_right_Percent ,

		<if test="sorting == 'cntSubmit'">
			rank() over(order by sum(MY_CNT_SUBMIT) desc)as ranking from
			wl_answer_result group by user_id
		</if>

		<if test="sorting == 'cntRight'">
			rank() over(order by sum(MY_CNT_RIGHT) desc)as ranking from
			wl_answer_result group by user_id
		</if>

		<if test="sorting == 'RightPercent'">
			rank() over(order by round(( sum(MY_CNT_RIGHT)/sum(MY_CNT_SUBMIT)*100),2)
			desc)as ranking from wl_answer_result group by user_id
		</if>

	</select>


</mapper>


















